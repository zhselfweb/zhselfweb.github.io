<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Note</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Cormorant+Garamond:ital,wght@0,600;1,500&display=swap"
      rel="stylesheet"
    />
    <style>
      /* --- ‚úíÔ∏è Â≠óÈ´îË®≠ÂÆö --- */
      @font-face {
        font-family: "ChenYuluoyan";
        src: url("https://cdn.jsdelivr.net/gh/chenyuluoyan/data@master/ChenYuluoyan-Thin.woff2")
          format("woff2");
        font-display: swap;
      }

      :root {
        --glass-surface: rgba(255, 255, 255, 0.65);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        overflow: hidden;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        height: 100vh;
        background: #f0f2f5;
        perspective: 2500px;
      }

      /* --- üßä ÂîØÁæéÂÖâÊöàËÉåÊôØ --- */
      #fridge-surface {
        position: absolute;
        inset: 0;
        z-index: 0;
        /* ÂçáÁ¥öÁÇ∫ÂîØÁæéÊº∏Â±§ + ÊµÅÂãïÊïàÊûú */
        background: radial-gradient(
            circle at center,
            rgba(167, 211, 237, 0.6) 0%,
            transparent 45%
          ),
          radial-gradient(
            circle at center,
            rgba(245, 203, 224, 0.6) 0%,
            transparent 45%
          ),
          linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
        background-size: 180% 180%, 180% 180%, 100% 100%;
        animation: gradient-flow 18s ease infinite alternate;
      }

      @keyframes gradient-flow {
        0% {
          background-position: 10% 10%, 90% 90%, 0% 0%;
        }
        50% {
          background-position: 90% 20%, 10% 80%, 0% 0%;
        }
        100% {
          background-position: 20% 90%, 80% 10%, 0% 0%;
        }
      }
      /* Â¢ûÂä†Á©∫Ê∞£ÊÑüÂô™Èªû */
      #fridge-surface::before {
        content: "";
        position: absolute;
        inset: 0;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
        opacity: 0.5;
        mix-blend-mode: overlay;
        pointer-events: none;
      }

      /* --- üíß UI Bar --- */
      #ui-container {
        position: absolute;
        top: 40px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 2147483647;
        perspective: 1000px;
        pointer-events: none;
      }

      #ui-bar {
        pointer-events: auto;
        display: flex;
        gap: 20px;
        padding: 8px 32px;
        border-radius: 999px;

        /* Liquid Glass / Ray Tracing Effect */
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.4) 0%,
          rgba(255, 255, 255, 0.1) 100%
        );
        backdrop-filter: blur(24px) saturate(180%);
        -webkit-backdrop-filter: blur(24px) saturate(180%);

        /* Borders and Shadows for Depth/Refraction */
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.2),
          inset 0 0 0 1px rgba(255, 255, 255, 0.2),
          inset 0 1px 0 0 rgba(255, 255, 255, 0.7),
          inset 0 -1px 0 0 rgba(255, 255, 255, 0.1);

        transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
      }

      #ui-bar:hover {
        transform: translateY(-1px);
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.5) 0%,
          rgba(255, 255, 255, 0.2) 100%
        );
        box-shadow: 0 20px 50px -10px rgba(0, 0, 0, 0.3),
          inset 0 0 0 1px rgba(255, 255, 255, 0.3),
          inset 0 1px 0 0 rgba(255, 255, 255, 0.9);
      }

      .btn {
        position: relative;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: none;
        background: rgba(255, 255, 255, 0.1);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #555;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2);
      }
      .btn:hover {
        color: #000;
        background: rgba(255, 255, 255, 0.3);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.6);
        transform: translateY(-1px);
      }
      .btn:active {
        transform: scale(0.92);
        background: rgba(255, 255, 255, 0.2);
      }
      .btn svg {
        width: 24px;
        height: 24px;
        filter: drop-shadow(0 1px 1px rgba(255, 255, 255, 0.2));
      }
      .btn-ai {
        color: #007aff;
        background: rgba(0, 122, 255, 0.1);
      }
      .btn-ai:hover {
        color: #0066cc;
        background: rgba(0, 122, 255, 0.2);
        box-shadow: 0 4px 12px rgba(0, 122, 255, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.4);
      }

      /* Spinner & Tooltip */
      .spinner {
        width: 20px;
        height: 20px;
        border: 2.5px solid rgba(0, 122, 255, 0.2);
        border-left-color: #007aff;
        border-radius: 50%;
        animation: spin 0.8s cubic-bezier(0.6, 0.2, 0.4, 0.8) infinite;
        display: none;
        position: absolute;
      }
      .btn.loading .icon-content {
        opacity: 0;
        transform: scale(0.5);
      }
      .btn.loading .spinner {
        display: block;
      }
      @keyframes spin {
        100% {
          transform: rotate(360deg);
        }
      }

      .btn::after {
        content: attr(data-tooltip);
        position: absolute;
        top: calc(100% + 12px);
        background: rgba(20, 20, 20, 0.8);
        color: #fff;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 500;
        letter-spacing: 0.5px;
        opacity: 0;
        pointer-events: none;
        transform: translateY(-5px);
        transition: all 0.2s ease;
        white-space: nowrap;
        backdrop-filter: blur(12px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .btn:hover::after {
        opacity: 1;
        transform: translateY(0);
      }

      /* --- üìÑ Note Container --- */
      .note-container {
        position: absolute;
        width: 260px;
        height: 260px;
        transform-style: preserve-3d;
        cursor: grab;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08),
          0 2px 6px rgba(0, 0, 0, 0.05);
        will-change: transform;
      }

      .note-container:active {
        cursor: grabbing;
      }

      .note-container.dragging {
        transition: none !important;
        z-index: 100000 !important;
        /* ÊãñÊõ≥ÊôÇÈô∞ÂΩ±Á®çÂæÆÂä†Ê∑± */
        box-shadow: 0 25px 40px rgba(0, 0, 0, 0.1);
      }

      .note-flipper {
        position: relative;
        width: 100%;
        height: 100%;
        transform-style: preserve-3d;
        transition: transform 0.6s cubic-bezier(0.4, 1.4, 0.6, 1);
      }
      .note-flipper.flipped {
        transform: rotateY(180deg);
      }

      .note-face {
        position: absolute;
        inset: 0;
        backface-visibility: hidden;
        border-radius: 2px;
        display: flex;
        flex-direction: column;
        padding: 36px 26px 24px 28px;
        overflow: hidden;
        background-color: #fdfcf0;
      }

      .note-face::before {
        content: "";
        position: absolute;
        inset: 0;
        background-image: url("data:image/svg+xml,%3Csvg width='300' height='300' viewBox='0 0 300 300' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='paperGrain'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.6' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23paperGrain)' opacity='0.12'/%3E%3C/svg%3E");
        mix-blend-mode: multiply;
        pointer-events: none;
        z-index: 1;
      }
      .note-face::after {
        content: "";
        position: absolute;
        bottom: 0;
        right: 0;
        width: 40px;
        height: 40px;
        background: linear-gradient(
          135deg,
          transparent 50%,
          rgba(0, 0, 0, 0.06) 55%,
          rgba(0, 0, 0, 0.02) 100%
        );
        pointer-events: none;
        border-radius: 0 0 2px 0;
        z-index: 2;
      }
      .note-front {
        z-index: 2;
      }

      .tape {
        position: absolute;
        top: -15px;
        left: 50%;
        transform: translateX(-50%) translateZ(10px) rotate(-1.5deg);
        width: 110px;
        height: 32px;
        z-index: 30;
        pointer-events: auto;

        /* ÊîπÁÇ∫Â∏∂ÊúâÂæÆÂΩ©ÂÖâÁöÑÂçäÈÄèÊòéÊùêË≥™ */
        background-color: rgba(255, 255, 255, 0.35);
        backdrop-filter: blur(3px);

        /* ÂæÆÂ¶ôÁöÑÂΩ©Ëâ≤Êº∏Â±§ÂÖâÊöà */
        background-image: linear-gradient(
            120deg,
            rgba(255, 255, 255, 0.4) 0%,
            rgba(220, 235, 255, 0.2) 50%,
            rgba(255, 220, 235, 0.2) 100%
          ),
          url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='1.5' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");

        /* Â¢ûÂä†ÁôºÂÖâÊÑü (Glow) */
        box-shadow: 0 2px 8px rgba(255, 255, 255, 0.4),
          0 1px 2px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.3);

        clip-path: polygon(
          2% 0%,
          98% 0%,
          100% 10%,
          98% 20%,
          100% 30%,
          98% 40%,
          100% 50%,
          98% 60%,
          100% 70%,
          98% 80%,
          100% 90%,
          98% 100%,
          2% 100%,
          0% 90%,
          2% 80%,
          0% 70%,
          2% 60%,
          0% 50%,
          2% 40%,
          0% 30%,
          2% 20%,
          0% 10%
        );

        transition: transform 0.2s ease;
      }

      .tape:hover {
        background-color: rgba(255, 255, 255, 0.5);
        box-shadow: 0 0 12px rgba(255, 255, 255, 0.6); /* Êá∏ÊµÆÊôÇÂÖâÊöàÊõ¥Âº∑ */
        transform: translateX(-50%) translateZ(10px) scale(1.02) rotate(0deg);
      }

      .note-text {
        font-family: "ChenYuluoyan", cursive;
        font-size: 28px;
        line-height: 1.6;
        color: #2c2c2e;
        margin-top: 10px;
        position: relative;
        z-index: 5;
        text-shadow: 0 1px 1px rgba(255, 255, 255, 0.5);
      }

      .note-back {
        transform: rotateY(180deg);
        background-color: #fdfdfd;
        z-index: 10;
      }

      .note-editor {
        border: none;
        background: transparent;
        font-family: "ChenYuluoyan", cursive;
        font-size: 26px;
        resize: none;
        outline: none;
        line-height: 1.6;
        color: #333;
        width: 100%;
        height: calc(100% - 30px);
        margin-top: 8px;
        background-image: linear-gradient(
          transparent 95%,
          rgba(0, 0, 0, 0.05) 95%
        );
        background-size: 100% 41.6px;
        z-index: 5;
        position: relative;
      }

      .ios-scroll {
        width: 100%;
        height: 100%;
        overflow-y: auto;
        padding-right: 4px;
      }
      .ios-scroll::-webkit-scrollbar {
        width: 0px;
      }

      .btn-magic {
        position: absolute;
        bottom: 16px;
        right: 16px;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: white;
        border: 1px solid rgba(0, 0, 0, 0.05);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #7f5af0;
        box-shadow: 0 4px 12px rgba(127, 90, 240, 0.15);
        transition: all 0.2s;
        z-index: 20;
      }
      .btn-magic:hover {
        transform: scale(1.1) rotate(15deg);
        box-shadow: 0 6px 16px rgba(127, 90, 240, 0.25);
      }

      /* --- üóë ÂûÉÂúæÊ°∂ (Z-Index Fix & Style) --- */
      #trash-zone {
        position: absolute;
        bottom: 40px;
        right: 40px;
        width: 72px;
        height: 72px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 24px;
        background: rgba(255, 255, 255, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(20px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1),
          inset 0 1px 1px rgba(255, 255, 255, 0.8);
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        /* üîß Fix: Â∞áÂ±§Á¥öË®≠ÁÇ∫Ê•µÈ´òÔºåÈ´òÊñºÊãñÊõ≥‰∏≠ÁöÑ‰æøÊ¢ùÁ¥ô (100000)ÔºåËß£Ê±∫Ë¶ÜËìãÂïèÈ°å */
        z-index: 200000;
        color: #8e8e93;
      }

      #trash-zone:hover,
      #trash-zone.active {
        transform: scale(1.15) translateY(-5px);
        background: rgba(255, 59, 48, 0.15);
        border-color: rgba(255, 59, 48, 0.3);
        color: #ff3b30;
        box-shadow: 0 20px 40px -5px rgba(255, 59, 48, 0.3),
          inset 0 0 20px rgba(255, 59, 48, 0.1);
      }

      .save-hint {
        position: absolute;
        bottom: 20px;
        left: 24px;
        font-size: 10px;
        color: #999;
        font-family: "Inter", sans-serif;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        font-weight: 600;
        opacity: 0.7;
        z-index: 5;
      }
    </style>
  </head>
  <body>
    <div id="fridge-surface"></div>

    <div id="ui-container">
      <div id="ui-bar">
        <button class="btn" id="add-btn" data-tooltip="Êñ∞Â¢û">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
        </button>
        <button class="btn btn-ai" id="ai-brain-btn" data-tooltip="AI">
          <div class="icon-content">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"
              ></path>
            </svg>
          </div>
          <div class="spinner"></div>
        </button>
        <button class="btn" id="undo-btn" data-tooltip="ÊÅ¢Âæ©Âà™Èô§">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M3 7v6h6"></path>
            <path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path>
          </svg>
        </button>
      </div>
    </div>

    <div id="notes-layer"></div>

    <div id="trash-zone">
      <svg
        width="28"
        height="28"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <polyline points="3 6 5 6 21 6"></polyline>
        <path
          d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
        ></path>
        <line x1="10" y1="11" x2="10" y2="17"></line>
        <line x1="14" y1="11" x2="14" y2="17"></line>
      </svg>
    </div>

    <script>
      const apiKey = "AIzaSyB6wm62aaw4tu943gzOxf4Dio34u5aFaqU";

      async function callGemini(prompt) {
        if (!apiKey) {
          alert("Ë´ãÂú®Á®ãÂºèÁ¢º‰∏≠Â°´ÂÖ• API Key ÊâçËÉΩ‰ΩøÁî® AI ÂäüËÉΩ üß†");
          return "Error: No API Key";
        }
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        try {
          const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [{ parts: [{ text: prompt }] }],
            }),
          });
          if (!response.ok) throw new Error("API Error");
          const data = await response.json();
          return data.candidates?.[0]?.content?.parts?.[0]?.text || "Hmm...";
        } catch (error) {
          console.error("Gemini Error:", error);
          return "AI Êö´ÊôÇ‰ºëÊÅØ‰∏≠ ‚òï";
        }
      }

      const notesLayer = document.getElementById("notes-layer");
      const trashZone = document.getElementById("trash-zone");
      const aiBrainBtn = document.getElementById("ai-brain-btn");

      let notes = [];
      let deletedStack = [];
      let zIndexCounter = 100;

      const PAPER_STYLES = [
        { bg: "#FDFCF0", text: "#424242" },
        { bg: "#E8F4F8", text: "#0277BD" },
        { bg: "#F3E5F5", text: "#7B1FA2" },
        { bg: "#E8F5E9", text: "#2E7D32" },
        { bg: "#FFF3E0", text: "#EF6C00" },
        { bg: "#FCE4EC", text: "#C2185B" },
      ];

      class Note {
        constructor(data) {
          this.id = data.id || Math.random().toString(36).substr(2, 9);
          this.x = data.x !== undefined ? data.x : window.innerWidth / 2 - 130;
          this.y = data.y !== undefined ? data.y : window.innerHeight / 2 - 130;
          this.text = data.text || "";
          this.rotation =
            data.rotation !== undefined ? data.rotation : Math.random() * 6 - 3;
          this.colorIdx =
            data.colorIdx !== undefined
              ? data.colorIdx
              : Math.floor(Math.random() * PAPER_STYLES.length);
          this.isFlipped = false;
          this.dragStartX = 0;
          this.dragStartY = 0;

          this.element = this.createDOM();
          this.render();

          this.lastPos = { x: 0, y: 0 };
          this.isDragging = false;
          this.setupEvents();
        }

        createDOM() {
          const el = document.createElement("div");
          el.className = "note-container";
          const style = PAPER_STYLES[this.colorIdx];

          el.innerHTML = `
            <div class="note-flipper">
              <div class="tape"></div>
              <div class="note-face note-front" style="background-color: ${
                style.bg
              };">
                 <div class="note-text ios-scroll" style="color: ${
                   style.text
                 }">${this.formatText(this.text) || "ÈªûÊìäÂÖ©‰∏ãÁ∑®ËºØ..."}</div>
              </div>
              <div class="note-face note-back">
                <textarea class="note-editor ios-scroll" style="color: ${
                  style.text
                }" placeholder="Âú®ÈÄôË£°ÂØ´‰∏ãÊÉ≥Ê≥ï...">${this.text}</textarea>
                <div class="save-hint">Double tap to save</div>
                <button class="btn-magic" title="AI Polish">
                   <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
                </button>
              </div>
            </div>
          `;

          notesLayer.appendChild(el);
          return el;
        }

        formatText(txt) {
          if (!txt) return "";
          return txt.replace(/\n/g, "<br>");
        }

        render() {
          this.element.style.transform = `translate3d(${this.x}px, ${this.y}px, 0) rotate(${this.rotation}deg)`;
          this.element.style.zIndex = zIndexCounter++;
        }

        setupEvents() {
          const flipper = this.element.querySelector(".note-flipper");
          const editor = this.element.querySelector(".note-editor");
          const textDisplay = this.element.querySelector(".note-text");
          const aiBtn = this.element.querySelector(".btn-magic");

          this.element.addEventListener("dblclick", (e) => {
            if (e.target.closest("button")) return;
            this.toggleFlip(flipper, editor, textDisplay);
          });

          aiBtn.addEventListener("click", async (e) => {
            e.stopPropagation();
            if (!this.text) return;

            const originalIcon = aiBtn.innerHTML;
            aiBtn.innerHTML = `<div style="width:16px;height:16px;border:2px solid #7F5AF0;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite"></div>`;

            const prompt = `Rewrite slightly to be more inspiring or concise (Keep language same): "${this.text}"`;
            const result = await callGemini(prompt);

            editor.value = result;
            this.text = result;
            aiBtn.innerHTML = originalIcon;
          });

          this.element.addEventListener(
            "mousedown",
            this.onDragStart.bind(this)
          );
          document.addEventListener("mousemove", this.onDragMove.bind(this));
          document.addEventListener("mouseup", this.onDragEnd.bind(this));

          this.element.addEventListener(
            "touchstart",
            (e) => {
              const touch = e.touches[0];
              this.onDragStart({
                clientX: touch.clientX,
                clientY: touch.clientY,
                target: e.target,
                preventDefault: () => e.preventDefault(),
              });
            },
            { passive: false }
          );
          document.addEventListener(
            "touchmove",
            (e) => {
              if (this.isDragging) e.preventDefault();
              const touch = e.touches[0];
              this.onDragMove({
                clientX: touch.clientX,
                clientY: touch.clientY,
              });
            },
            { passive: false }
          );
          document.addEventListener("touchend", this.onDragEnd.bind(this));
        }

        toggleFlip(flipper, editor, textDisplay) {
          this.isFlipped = !this.isFlipped;
          if (this.isFlipped) {
            flipper.classList.add("flipped");
            setTimeout(() => editor.focus(), 200);
          } else {
            this.text = editor.value;
            textDisplay.innerHTML =
              this.formatText(this.text) || "ÈªûÊìäÂÖ©‰∏ãÁ∑®ËºØ...";
            flipper.classList.remove("flipped");
            saveData();
          }
        }

        onDragStart(e) {
          if (
            this.isFlipped &&
            (e.target.tagName === "TEXTAREA" || e.target.closest(".btn-magic"))
          )
            return;
          if (e.target.closest(".btn")) return;

          this.isDragging = true;
          this.lastPos = { x: e.clientX, y: e.clientY };
          this.dragStartX = this.x;
          this.dragStartY = this.y;

          this.element.style.zIndex = zIndexCounter + 200;
          this.element.classList.add("dragging");
          this.element.style.cursor = "grabbing";

          this.element.style.transform = `translate3d(${this.x}px, ${this.y}px, 0) scale(1.02) rotate(0deg)`;
        }

        onDragMove(e) {
          if (!this.isDragging) return;

          const dx = e.clientX - this.lastPos.x;
          const dy = e.clientY - this.lastPos.y;

          this.x += dx;
          this.y += dy;
          this.lastPos = { x: e.clientX, y: e.clientY };

          this.element.style.transform = `translate3d(${this.x}px, ${this.y}px, 0) scale(1.02) rotate(0deg)`;

          // ÂûÉÂúæÊ°∂ÈÇèËºØ
          const trashRect = trashZone.getBoundingClientRect();
          const noteRect = this.element.getBoundingClientRect();
          const centerX = noteRect.left + noteRect.width / 2;
          const centerY = noteRect.top + noteRect.height / 2;

          const trashCenterX = trashRect.left + trashRect.width / 2;
          const trashCenterY = trashRect.top + trashRect.height / 2;
          const dist = Math.hypot(
            centerX - trashCenterX,
            centerY - trashCenterY
          );

          if (dist < 80) {
            trashZone.classList.add("active");
          } else {
            trashZone.classList.remove("active");
          }
        }

        onDragEnd() {
          if (!this.isDragging) return;
          this.isDragging = false;
          this.element.classList.remove("dragging");
          this.element.style.cursor = "grab";

          if (trashZone.classList.contains("active")) {
            this.performDeleteAnimation();
          } else {
            this.element.style.transition =
              "transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1)";
            this.render();
            saveData();
          }
        }

        performDeleteAnimation() {
          const trashRect = trashZone.getBoundingClientRect();
          const trashCenterX = trashRect.left + trashRect.width / 2;
          const trashCenterY = trashRect.top + trashRect.height / 2;

          // üîß Fix: Âà™Èô§ÂãïÁï´ÂÑ™Âåñ - ‰∏çÊóãËΩâÔºåÂñÆÁ¥îÁ∏ÆÂ∞èËàáÊ∑°Âá∫
          this.element.style.transition =
            "all 0.4s cubic-bezier(0.2, 0, 0.2, 1)";

          // ÁßªÂãïÂà∞ÂûÉÂúæÊ°∂‰∏≠ÂøÉ
          this.x = trashCenterX - 130;
          this.y = trashCenterY - 130;

          // üîß Fix: ÁßªÈô§ rotate(180deg)ÔºåÊîπÁÇ∫ scale(0.1) Âíå opacity 0
          this.element.style.transform = `translate3d(${this.x}px, ${this.y}px, 0) scale(0.1)`;
          this.element.style.opacity = "0";

          trashZone.classList.remove("active");

          setTimeout(() => {
            this.delete();
          }, 400);
        }

        delete() {
          deletedStack.push({
            id: this.id,
            x: this.dragStartX,
            y: this.dragStartY,
            text: this.text,
            rotation: this.rotation,
            colorIdx: this.colorIdx,
          });
          notes = notes.filter((n) => n !== this);
          this.element.remove();
          saveData();
        }
      }

      function addNote(data = {}) {
        const note = new Note(data);
        notes.push(note);
        saveData();
      }

      function saveData() {
        const data = notes.map((n) => ({
          id: n.id,
          x: n.x,
          y: n.y,
          text: n.text,
          rotation: n.rotation,
          colorIdx: n.colorIdx,
        }));
        localStorage.setItem("fridge_notes_aesthetic", JSON.stringify(data));
        localStorage.setItem(
          "fridge_notes_deleted_v6",
          JSON.stringify(deletedStack)
        );
      }

      function loadData() {
        const saved = JSON.parse(
          localStorage.getItem("fridge_notes_aesthetic")
        );
        if (saved && saved.length > 0) {
          saved.forEach((n) => addNote(n));
        } else {
          addNote({
            text: "ÈªûÂÖ©‰∏ãÁ∑®ËºØ„ÄÅÂÑ≤Â≠ò",
            rotation: -2,
          });
          addNote({
            text: "ÊãñÊõ≥Âà∞ÂûÉÂúæÊ°∂",
            x: window.innerWidth / 2 + 60,
            y: window.innerHeight / 2 + 60,
            colorIdx: 3,
            rotation: 3,
          });
        }
      }

      document.getElementById("add-btn").addEventListener("click", () => {
        const x = window.innerWidth / 2 - 130 + (Math.random() * 40 - 20);
        const y = window.innerHeight / 2 - 130 + (Math.random() * 40 - 20);
        addNote({ x, y });
      });

      document.getElementById("undo-btn").addEventListener("click", () => {
        if (deletedStack.length === 0) return;
        const lastData = deletedStack.pop();
        addNote(lastData);
      });

      aiBrainBtn.addEventListener("click", async () => {
        if (notes.length === 0) return;
        aiBrainBtn.classList.add("loading");

        const allText = notes
          .map((n) => n.text)
          .filter((t) => t.trim().length > 0)
          .join("\n---\n");
        if (!allText) {
          aiBrainBtn.classList.remove("loading");
          return;
        }

        const prompt = `Analyze these sticky notes and provide a fun, short insight or summary in Traditional Chinese (NO Markdown): \n${allText}`;
        const insight = await callGemini(prompt);
        aiBrainBtn.classList.remove("loading");
        addNote({
          text: `Â§ßËÅ∞ÊòéAI:\n${insight}`,
          colorIdx: 1,
          x: window.innerWidth / 2,
          y: window.innerHeight / 2,
        });
      });

      loadData();
    </script>
  </body>
</html>
